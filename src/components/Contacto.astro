---
const coords = { lat: -34.9277725, lng: -58.609375, zoom: 17 };
---

<section id="CONTACTO" class="scroll-mt-16 py-2 sm:py-4 bg-[var(--bp-bg-alt)]">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="grid gap-10 lg:grid-cols-2 items-stretch">
      <!-- Mapa (slide-in más lento) -->
      <div
        class="rounded-2xl overflow-hidden ring-1 ring-[var(--bp-border)] shadow-sm bg-[var(--bp-surface)] reveal reveal--slide"
        style="--delay: 80ms"
      >
        <div
          id="bp-map"
          class="aspect-[16/10] w-full"
          data-lat={coords.lat}
          data-lng={coords.lng}
          data-zoom={coords.zoom}
          data-address="Ruta nacional 205 km 11330 , Barrio Cerrado Laguna Azul , Ezeiza"
        >
        </div>
      </div>

      <!-- Datos (fade-up escalonado más lento) -->
      <div class="flex flex-col justify-center">
        <h2
          class="text-2xl md:text-3xl font-extrabold tracking-tight text-[var(--bp-ink)] reveal"
          style="--delay: 0ms"
        >
          Contacto
        </h2>

        <div class="mt-6 flex flex-wrap gap-3 reveal" style="--delay: 200ms">
          <a
            href="#"
            data-reserva-open
            class="inline-flex items-center gap-2 rounded-xl px-5 py-3 font-semibold text-[#111] bg-[var(--bp-accent)] hover:bg-[var(--bp-accent-600)] shadow-sm"
          >
            Reservar
          </a>
          <!-- <a
            id="bp-directions"
            class="inline-flex items-center gap-2 rounded-xl px-5 py-3 font-semibold text-white bg-[var(--bp-primary)] hover:bg-[var(--bp-primary-600)] shadow-sm"
            target="_blank"
            rel="noopener"
          >
            Cómo llegar
          </a> -->
        </div>

        <ul class="mt-6 space-y-3">
          <li class="reveal" style="--delay: 320ms">
            <p
              class="text-base md:text-xl font-extrabold tracking-tight text-[var(--bp-ink)]"
            >
              Dirección
            </p>
            <p class="text-[var(--bp-ink)] mt-3 text-xl">
              Ruta nacional 205 km 11330 , Barrio Cerrado Laguna Azul , Ezeiza
            </p>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <script is:inline>
    // ===== Animaciones con IntersectionObserver (50% visible + más lento) =====
    (() => {
      const prefersReduced = window.matchMedia(
        "(prefers-reduced-motion: reduce)"
      ).matches;
      if (prefersReduced) return;

      const els = document.querySelectorAll(".reveal");
      const io = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
              entry.target.classList.add("in");
              io.unobserve(entry.target);
            }
          }
        },
        { threshold: 0.5 } // 50% visible
      );
      els.forEach((el) => io.observe(el));
    })();
  </script>

  <script is:inline>
    // ===== Mapa Leaflet (por dirección, con fallback a lat/lng) =====
    (async function () {
      if (!window.L) return;
      const el = document.getElementById("bp-map");
      if (!el) return;

      const zoom = parseInt(el.dataset.zoom || "16", 10);
      const hasLatLng = el.dataset.lat && el.dataset.lng;
      const fallback = [
        Number.parseFloat(el.dataset.lat) || -34.853, // Ezeiza aprox
        Number.parseFloat(el.dataset.lng) || -58.536,
      ];

      const address = el.dataset.address || "";
      let center = fallback;

      async function geocode(q) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=ar&q=${encodeURIComponent(q)}`;
        const r = await fetch(url, { headers: { Accept: "application/json" } });
        if (!r.ok) throw new Error("geocode failed");
        const arr = await r.json();
        if (!arr || !arr.length) throw new Error("no results");
        return [parseFloat(arr[0].lat), parseFloat(arr[0].lon)];
      }

      try {
        if (hasLatLng && !address) {
          center = [parseFloat(el.dataset.lat), parseFloat(el.dataset.lng)];
        } else if (address) {
          center = await geocode(address);
        } else if (hasLatLng) {
          center = [parseFloat(el.dataset.lat), parseFloat(el.dataset.lng)];
        }
      } catch (_) {
        center = fallback;
      }

      const map = L.map(el, {
        zoomControl: true,
        scrollWheelZoom: false,
      }).setView(center, zoom);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const pin = L.divIcon({
        className: "bp-pin-wrap",
        html: '<div class="bp-pin"></div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13],
        popupAnchor: [0, -14],
      });

      const marker = L.marker(center, { icon: pin }).addTo(map);

      //const COMO_LLEGAR = `https://www.google.com/maps/dir/?api=1&destination=${center[0]},${center[1]}`;
      marker.bindPopup(`
      <strong>Estacionamiento Blue Parking</strong><br/>
      ${address ? address : `${center[0].toFixed(5)}, ${center[1].toFixed(5)}`}
    `);

      const dir = document.getElementById("bp-directions");
      if (dir) dir.href = COMO_LLEGAR;

      map.on("click", () => map.scrollWheelZoom.enable());
    })();
  </script>

  <style is:global>
    /* ===== Pin del mapa ===== */
    .bp-pin {
      position: relative;
      width: 26px;
      height: 26px;
      border-radius: 9999px;
      background: var(--bp-primary);
      border: 3px solid #fff;
      box-shadow: 0 0 0 4px
        color-mix(in srgb, var(--bp-primary) 35%, transparent);
    }
    .bp-pin::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 9999px;
      box-shadow: 0 0 0 0 rgba(29, 87, 168, 0.35);
      animation: bp-pulse 2.2s ease-out infinite; /* un toque más lenta */
    }
    @keyframes bp-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(29, 87, 168, 0.35);
      }
      70% {
        box-shadow: 0 0 0 14px rgba(29, 87, 168, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(29, 87, 168, 0);
      }
    }

    /* ===== Reveals (más lentas) ===== */
    @media (prefers-reduced-motion: no-preference) {
      .reveal {
        opacity: 0;
        transform: translateY(10px) scale(0.985);
        transition:
          opacity 1s ease,
          transform 1s cubic-bezier(0.22, 0.65, 0.2, 1);
        transition-delay: var(--delay, 0ms);
        will-change: transform, opacity;
      }
      .reveal--slide {
        transform: translateX(64px);
      }
      .reveal.in {
        opacity: 1;
        transform: none;
      }
    }
  </style>
</section>
